### TBNTB 개발을 진행하면서 연관관계 및 영속성 컨텍스트에서 놓치기 쉬운 부분들에 대해서 정리해 보겠다.

오늘 만난 문제는 아래와 같다.

### 비영속된 엔티티를 연관관계를 연결시키면 오류가 발생한다.

자세한 내용은 아래와 같다.

projectEntity가 영속성 컨텍스트에 등록이 되지 않은 상황에서  
연관관계 중 하나인 CategoryEntity를 findById 형태로 조회하는 메서드가 있었다.

projectEntity와 categoryEntity를 연관관계로 등록한 뒤 해당 코드를 실행하니,  
영속화되지 않은 projectEntity로 인해 문제가 발생했다.

JPA는 FlushMode.AUTO 환경에서 JPQL 쿼리를 실행하기 전에  
쿼리 결과의 일관성을 위해 영속성 컨텍스트의 변경 내용을 flush 할 수 있다.

이때 연관관계에서 비영속 엔티티를 참조하고 있으면  
flush 과정에서 예외가 발생할 수 있다.

따라서 문제의 핵심은  
**조회 과정에서 발생한 flush와 비영속 참조가 섞인 연관관계 상태**에 있다.

### 해결 과정

1. Service Layer에서 먼저 projectEntity를 저장하여 영속 상태로 만들었다.
2. ID 전략이 IDENTITY가 아닌 SEQUENCE이므로 save() 시점에는  
   엔티티가 영속성 컨텍스트에 등록되고 INSERT SQL은 쓰기 지연 저장소에 쌓인다.
3. 이후 findById 등의 조회 쿼리가 실행되면서 flush가 발생하고,  
   쓰기 지연 저장소의 쿼리가 DB로 실행되어 메모리와 DB 간의 일관성이 맞춰진다.

## 개요 
- [ ]   Redis AOF 장애 복구에 관하여 
- [ ] RTO RPO 개념에 관하여
- [ ] Source of Fast Truth 개념에 관하여

현재 Redis 서버는 단일 노드로 운영 중이다.
좋아요(Like) 관련 비지니스 로직은 다음과 같은 구조르르 가진다.

| Redis에 좋아요 종보를 먼저 저장한 뒤, 특정 주기 또는 이벤트 시점에 DB로 동기화

이 구조는 빠른 응답성과 높은 트래픽 처리를 위해 Redis를 Soruce of Fast Truth로 활용ㅇ하는 전형적인 패턴이다.

여기서 잠깐 Source of Fast Truth란 모든 정보들을 바로 DB I/O작업을 거치는 대신 메모리 접근에 용이한 Redis에 저장하여 빠르게 정보를 관리하는 방식이다.

## 문제 
문제는 Redis -> DB 동기화가 일어나기 전에 Redis 서버가 종료되거나 장애가 발생하는 경우이다.
이 경우 다음과 같은 문제가 발생한다.

- Redis 메모리에만 존재하던 좋아요 데이터 유실
- DB에는 아직 반영되지 않았기 때문에 복구 불가능
- 결과적으로 데이터 영속성 문제가 발생한다.

  즉 Redis를 단순 캐시가 아니라 비지니스 상태를 저장하는 계층으로 사용하면서도, 영속성에 대한 대비가 충분하지 않은 상태ㅏ.

  ## 해결을 위한 개념

AOF (Append Only File)
RTO (Recovery Time Objective)
RPO (Recovery Point Objective) 

이 세 개념은 Redis 영속성뿐 아니라 전체 시스템 장애 복구 전략을 설계할 때 함께 고려한다.

### AOF (Append Only File)
AOF는 Redis의 영속성 메커니증 중 하나다.

Redis에 수행되는 모든 쓰기 명령을 순차적으로 파일에 append 
서버 재시작 시, 이 파일을 다시 실행 하여 데이터 복구한다. 
즉 Redis가 꺼지더라도, 명령 기록을 통해 상태를 복원한다. 

약간 DB에서 log를 기록는 undo_log파일 같은거라 생각하면 된다.

간단한 동작 방식은 아래와 같다.
1. 클라이언트가 Redis 명령을 같은 쓰기 명령을 보낸다.
2. Redis에는 메모리에 반영한 뒤 동시에 AOF 파일에 명령을 기록한다.
3. Redis 재시작 시 AOF 파일을 처음부터 끝까지 재실해하여 동일한 데이터 상태를 구성한다.

### 장점 
RPO 최소화 기능 => appendfsync always 설정 시 거의 데이터 유실이 없다.
RDB 스냅샷보다 더 정밀한 복구가 가능하다고 한다.
Redis를 사실상 영속 저장소처럼 사용 가능하다.

### 단점
파일 크기가 커질 수 있다
디스크 I/O 부담이 증가한다.
재시작 시 AOF 재생 시간이 길어질 수 있다.

이를 해결하기 위해 Redis는 AOF Rewirte(압축) 기능을 제공한다고 하는데 현재 개념에서 이 부분은 정리 안하겠다.

### 다음 개념 RTO(Recovery Time Onjective) 
RTO는 장애 발생 후 서비스가 다시 정상 동작하기까지 허용 가능한 최대 시간이다.
쉽게 말해서 장애가 발생하면 5분안에 복구를 해아한다. 그러면 RTO 는 5분이다.
Redis만 정상 작동하면 안되고 데이터복구 서비스 재개 모두 포함한 시간이다.

AOF와 RTO의 관계를 잠깐 설명해 보자면 AOF파일이 클수록 재시작 시 replay 시간이 길어져 RTO가 ㅈ증가한다.

### RPO (Recovery Point Objective)
RPO는 장애 발생 시 얼마나 이전 시점까지의 데이터를 허용 가능한가를 의미한다. 
쉽게 말해 최대 얼마만큼의 데이터 유실을 감수할 수 있는가?? 이다.

에를들어 Redis + 좋아요 시스템에서의 RPO
1. RPO = 0  이 말은 좋아요 하나라도 유실되면 안 되는 경우
2. RPO = 수초 일부좋아요 유실은 허용 가능하다.
AOF 설정에 따라 RPO가 달라진다고 한다.
설정에는 아래와 같은 설정이 있다.
- appendfsync always
- appendfsync everysec
- appendfsync no

해당 AOF기능을 이용하여 현재 서비스의 Redis의 영속성 문제를 어느정도 해결 가능한 것으로 보인다.


